(in-package :tempus)

(defclass player-record ()
  ((idnum :accessor idnum-of :initarg :idnum)
   (account :accessor account-of :initarg :account)
   (name :accessor name-of :initarg :name)))

(defclass account ()
  ((idnum :accessor idnum-of :initarg :idnum)
   (name :accessor name-of :initarg :name)
   (password :reader password-of :initarg :password)
   (email :accessor email-of :initarg :email)
   (creation-time :accessor creation-time-of :initarg :creation-time)
   (creation-addr :accessor creation-addr-of :initarg :creation-addr)
   (login-time :accessor login-time-of :initarg :login-time)
   (login-addr :accessor login-addr-of :initarg :login-addr)
   (entry-time :accessor entry-time-of :initarg :entry-time)
   (ansi-level :accessor ansi-level-of :initarg :ansi-level :initform 0)
   (compact-level :accessor compact-level-of :initform 0)
   (term-height :accessor term-height-of :initarg :term-height :initform 22)
   (term-width :accessor term-width-of :initarg :term-width :initform 80)
   (trust :accessor trust-of :initarg :trust :initform 0)
   (reputation :accessor reputation-of :initarg :reputation :initform 0)
   (quest-points :accessor quest-points-of :initarg :quest-points :initform 0)
   (banned :accessor banned-of :initarg :banned :initform nil)
   (quest-banned :accessor quest-banned-of :initarg :quest-banned :initform nil)
   (bank-past :accessor past-bank-of :initform 0)
   (bank-future :accessor future-bank-of :initform 0)
   (metric-units :accessor metric-units-of :initform nil)
   (players :accessor players-of :initform nil))
  (:default-initargs :password "" :email ""
                                :creation-time (now)
                                :creation-addr ""
                                :login-time (now)
                                :login-addr ""
                                :entry-time (now)))


(defvar *account-max-idnum* 0)
(defvar *account-idnum-cache* (make-hash-table))
(defvar *account-name-cache* (make-hash-table :test 'equal))

(defun random-salt ()
  "Returns a string of the format $1$xxxxxxxx$ where x is a random
alphanumeric character.  This is for use in making crypt() return an
md5 hash."
  (let ((salt-table
         "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz./"))
    (format nil "$1$狺あ祜镳蝈疱狒泔祆邈ㄣ栳筢祠翎忪蜥钿镯洞┅┅┅ㄤ彐躅箦翩疳篌黠蜾镦疳篌黠蜾徙泔躅舂⒃栝轶箪雉黩轸弪骘徙泔躅疳篌黠蜾麒殂狨麸磲糸汜祆栳箬弩翳疳篌黠蜾箦翩箪雉鲠祯徙泔躅ю狍篦矧洎ㄣ蝙痿疳篌黠蜾疳篌黠蜾蜥钿镯筢祠┅┅ㄤ彐躅徙泔躅舡怙雉īㄣ祢栳箬徙泔躅舡殇铛憝汜汨濯ㄣ祢栳箬徙泔躅舡钺礤汜汨濯箪镧⑶弭糸铉磲徙泔躅殇铛恝箦翩徙泔躅舡磲殇铛愍磲徙泔躅舡殇┅箪镧⑶弭糸铉汨狎徙翦泔躅簪戾è痨狴弪泔躅痫篝盹溴蝾厚蹂蝙ê箦戾泗ê泔躅И烘蝻ю灬弪螬后轭珈濠┅ㄩ弪镳痨狴弪泔躅舂箪镧⒆烈紊吻物汨狎徙翦蝮祜徜邃箪镧汨狎徙翦蟒轭溻痨狴弪泔躅痨狴弪泔躅舂┅ㄤ彐躅磲徙泔躅舡殇ī⒁弭躜铙翳磲轫蹴徙泔躅殇轭翳溽翎忉箦戾è蝈篚祠痫篝盹溴蝾厚蹂蝙ê箦戾泗ê磲ч漕蹴烘蝻п沣秕铘螬后轭珈濠┅ㄩㄥ耢蝈篚祠侯蹯飑蝈篚祠┅ㄤ彐躅磲痨狴弪殇ī⒁弭躜铙翳磲轫蹴痨狴弪殇轭翳溽翎忉箦戾è蝈篚祠痫篝盹溴蝾厚蹂蝙ê箦戾泗ê磲ч漕蹴烘蝻ю灬弪螬后轭珈濠┅ㄩㄥ耢蝈篚祠侯蹯飑蝈篚祠┅ㄤ彐躅徙泔躅舡屮轶趔钺礤⒁弭躜铙趄蹂殒翳徙泔躅鏖翳翳玳鲥钺礤屮轶趔澡泔眇狎轶镱轶汜箦轭箦铙轸轹瀹痫篝盹溴蝾厚蹂蝙ê箦戾泗ê泔躅И烘蝻п沣秕铘瑚桢蝈êê祜麇ь犴濠篝蜷铉滹黝汜箦钺礤┅后轭珈濠暴ㄤ彐躅泸遽翦徙泔躅钺礤戾è铄鳝徙泔躅磲脲轭篝犷沐п沣秕铘洪漕蹴ū磲徙泔躅舡殇┅侯犴钺礤┅痫篝盹溴蝾哄邈豸ê轭箦螋轭麸п沣秕铘后弭ч漕蹴ㄩ漕蹴镦铄鳝徙泔躅舂┅筢鲥徙泔躅铄鳝徙泔躅舂铄鳝徙泔躅舂ㄤ彐躅徙泔躅舡怡殇铛ㄩ漕蹴⒁弭躜铙翳徙泔躅狍箫汩狒邃鏖翳翳玳鲥殇澡徙泔躅磲忮祜徜邃骝镯翳溽翎忉箦矧轸磲忮蝈趄殄鲥骝镯汜汨瀹戾舄è汜汨邃ㄧ弭栳箬殇铛徙泔躅舡殇铛憝汜汨濯铋飑┅ㄩ汜汨邃汜汨邃戾è蝈篚祠痫篝盹溴蝾厚蹂蝙ê箦戾泗И烘蝻п沣秕铘瑚桢蝈êч漕蹴殇铛愆横扉篝┅ㄡ沣秕铘磲脲轭篝犷沐п沣秕铘┅麒孱蝈篚祠祜镳鏖翳翦眇躞痣ㄦ轭洵疳汶徵呼屙瘐螬骘趱痨轭蝈篚祠躅戾篌ㄥ耢ㄣ潋趱痨濠侯蹯飑滹箦翩箪雉鲠祯徙泔躅ㄩ铘弪簌礅镬钺礤ㄣ狎趱痨濠翦眇躞痣绌ㄣ潋趱痨濠┅箦翩ㄧ弭栳箬钺礤镦徙泔躅舂徙泔躅舡钺礤汜汨濯徙泔躅舂箦翩ㄧ弭栳箬ㄩ漕蹴镦徙泔躅舂徙泔躅舡殇铛憝汜汨濯徙泔躅舂箦翩痨狴弪蟓镦徙泔躅舂磲疸狎灬礅溽ㄩ铈铹磲脲轭篝犷沐ю灬弪蝈泔蜾洪漕蹴ㄣ潋ㄡ篌镢洪漕蹴轭骘┅横沣秕铘ㄩ漕蹴镦徙泔躅舂侯犴ㄣ潋ㄡ篌镢侯犴轭骘┅┅痫篝盹溴蝾厚蹂蝙ê矧溴颦怡ê箦戾泗ч漕蹴ь犴烘蝻ю灬弪瑚桢蝈êп沣秕铘ㄩ漕蹴镦徙泔躅舂┅ч漕蹴横扉篝螬┅徙泔躅舂┅┅ㄤ彐躅祜徜徙泔躅钺礤⒁弭躜铙翳徙泔躅狍箫汩狒邃鏖翳翳玳鲥钺礤澡徙泔躅磲忮祜徜邃骝镯翳溽翎忉箦矧轸磲忮蝈趄殄鲥骝镯汜汨瀹戾舄è汜铒铋汜飙钺礤篝蜷铉滹黝汜箦钺礤┅ㄣ徙桢ㄧ弭栳箬汜铒铋汜飙钺礤徙泔躅舡钺礤汜汨濯铋飑┅ㄩ汜汨邃汜汨邃戾è蝈篚祠痫篝盹溴蝾厚蹂蝙ê箦戾泗И烘蝻п沣秕铘瑚桢蝈êê祜麇ь犴濠汜铒铋汜飙钺礤┅横扉篝┅ㄡ沣秕铘磲脲轭篝犷沐п沣秕铘┅麒孱蝈篚祠祜镳鏖翳翦眇躞痣ㄦ轭洵疳汶徵呼屙瘐螬骘趱痨轭蝈篚祠躅戾篌ㄥ耢ㄣ潋趱痨濠侯蹯飑滹箦翩箪雉鲠祯徙泔躅ㄩ铘弪簌礅镬钺礤ㄣ狎趱痨濠翦眇躞痣绌ㄣ潋趱痨濠┅箦翩ㄧ弭栳箬汜铒铋汜飙钺礤徙泔躅舡钺礤汜汨濯徙泔躅舂箦翩ㄧ弭栳箬ㄩ漕蹴镦徙泔躅舂徙泔躅舡殇铛憝汜汨濯徙泔躅舂箦翩痨狴弪蟓镦徙泔躅舂磲疸狎灬礅溽ㄩ铈铹磲脲轭篝犷沐ю灬弪蝈泔蜾洪漕蹴ㄣ潋ㄡ篌镢洪漕蹴轭骘┅横沣秕铘ㄩ漕蹴镦徙泔躅舂侯犴ㄣ潋ㄡ篌镢侯犴轭骘┅┅痫篝盹溴蝾厚蹂蝙ê矧溴颦怡ê箦戾泗ч漕蹴ь犴烘蝻ю灬弪瑚桢蝈êп沣秕铘ㄩ漕蹴镦徙泔躅舂┅ч漕蹴横扉篝螬┅徙泔躅舂┅┅ㄤ彐礤翳镤筢鲥徙泔躅è徙泔躅徙泔躅舂⒂狯弩翳徙泔躅轭骘蝽狒轱轭麸翳溽翎忉箦痫篝盹溴蝾哄邈豸ê躔溽翦п沣秕铘后弭ь犴钺礤镦徙泔躅舂ю狍篦矧疳篌黠蜾镦徙泔躅舂у磲殪ㄥ磲殪镦徙泔躅舂ъ镧轭糸礤祜玳瞽糸礤镦徙泔躅舂ъ镧轭徜潋祜玳瞽徜潋镦徙泔躅舂у铘蝙糸礤ㄥ铘蝙糸礤镦徙泔躅舂п铙榄戾鲥ㄡ铙榄戾鲥飙镦徙泔躅舂с镯疳泗戾鲥ㄣ镯疳泗戾鲥飙镦徙泔躅舂翦蝽桢殓梏翦蝽桢殓梏镦徙泔躅舂翦蝽鏖漪翦蝽鏖漪璀镦徙泔躅舂р犷氕疳篝疳篝忉铍镦徙泔躅舂р犷氕骢趱蝈ㄦ豸躜瀛忉铍镦徙泔躅舂瑚桢蝈êч漕蹴ㄩ漕蹴镦徙泔躅舂┅┅ㄤ彐躅徙泔躅舡祜玳ㄡ沣秕铘泺瞟⑿弪骘蝽铄沐篌狎翎箅骘犷徙泔躅躔镱篚沣弩箧蹯祜玳町箦翩祜玳瞽糸礤镦徙泔躅舂铒鳗箦翩祜玳瞽徜潋镦徙泔躅舂疱弪徜潋镦泺瞟筢鲥徙泔躅徙泔躅舂簌箪镧祜珑邃轭钺礤镦徙泔躅舂┅ㄤ彐躅徙泔躅舡祜顼豸ㄡ沣秕铘泺瞟箦翩祜玳瞽糸礤镦徙泔躅舂铒鳗箦翩祜玳瞽徜潋镦徙泔躅舂疱弪徜潋镦泺瞟筢鲥徙泔躅徙泔躅舂簌箪镧祜珑邃秕簪钺礤镦徙泔躅舂┅换吁痧矧骘孱泸痿邃疳篌黠蜾趄犷箜轶箝镱ㄣ骀楹溴骈铄骘蝈殓瞽扉怛狎扉忏蝙痿ê躅轼ê溴驷蹯㈧殁泸痿┅ㄣ骀楹躞瀛骘蝈殓瞽扉怛狎扉忏蝙痿ㄤ彐躅泸痿疳篌黠蜾疳篌黠蜾筢祠⑴钽蝙痿疳篌黠蜾鏖翳栳箬ㄣ骀楹骘蝈殓瞽骢钽犰泸痿后趄轭疳篌黠蜾后趄轭筢祠后趄轭绌ㄤ彐躅汨邈氕疳篌黠蜾ㄡ沣秕铘疳篌黠蜾⒛弭弪黹铄殒翳栳箬镦翳玳鲥疳篌黠蜾磲翥桢翳篝矧邃栳箬篝蜷铉疳篌黠蜾镦徙泔躅舂ㄣ蝙痿疳篌黠蜾疳篌黠蜾疳篌黠蜾镦徙泔躅舂┅ㄤ彐躅鲠扉溽翦钺礤钺礤⒁弭躜铙殒翳玳鲥篝蜷铉轶镫麸躞狍痨狴弪钺礤义趱蝾紊殒轸轶轭鲠扉轭箫礤麽ㄡ钿铒篝蜷铉钺礤┅ㄥ鲥蝙灬礅溽ㄣ矧ㄥ耢＼Зㄡ祓栳汨狎悌┅钺礤┅ㄤ彐躅痨狴弪钺礤屮轶趔钺礤⒁弭躜铙殒痨狴弪屮轶趔鏖翳翳玳鲥钺礤痨躞痫篝盹溴蝾厚蹂蝙ê箦戾泗ê泔躅И烘蝻ю灬弪瑚桢蝈êê祜麇ь犴濠篝蜷铉滹黝汜箦钺礤┅后轭珈濠┅ㄤ彐躅蝈趄殄鲥痨狴弪殇铛钺礤⒁弭蜷弼弩翳殇铛镦翳痨狴弪鏖翳翳玳鲥钺礤骝镯翳溽翎忉箦义趱蝾紊殒翳痨狴弪溟铒屮轶舢痫篝盹溴蝾厚蹂蝙ê箦戾泗ч漕蹴烘蝻ю灬弪瑚桢蝈êê祜麇ь犴濠篝蜷铉滹黝汜箦钺礤┅后轭珈濠ㄤ彐躅蝈趄殄鲥痨狴弪钺礤ㄩ漕蹴⒁弭蜷弼弩翳钺礤镦翳痨狴弪鏖翳翳玳鲥殇铛骝镯翳溽翎忉箦义趱蝾紊殒翳痨狴弪溟铒屮轶舢痫篝盹溴蝾厚蹂蝙ê箦戾泗ь犴烘蝻ю灬弪瑚桢蝈êч漕蹴殇铛愆后轭珈濠ㄤ彐躅蝈趄殄鲥痨狴弪徙泔躅ㄩ漕蹴⒁弭蜷弼弩翳徙泔躅殇镦翳痨狴弪鏖翳翳玳鲥殇铛骝镯翳溽翎忉箦义趱蝾紊殒翳痨狴弪溟铒屮轶舢痫篝盹溴蝾厚蹂蝙ê箦戾泗п沣秕铘烘蝻ю灬弪瑚桢蝈êч漕蹴殇铛愆后轭珈濠ㄤ彐躅蝈趄殄鲥徙泔躅舡钺礤ㄩ漕蹴⒁弭蜷弼弩翳钺礤镦翳徙泔躅鏖翳翳玳鲥殇铛骝镯翳溽翎忉箦矧翳汜汨瀹义趱蝾紊殒翳徙泔躅滹弩铒屮轶舢戾è徙泔躅ㄧ弭栳箬殇铛徙泔躅舡殇铛憝汜汨濯┅ㄩ徙泔躅钺礤镦徙泔躅舂痫篝盹溴蝾厚蹂蝙ê箦戾泗ь犴烘蝻п沣秕铘瑚桢蝈êч漕蹴殇铛愆后轭珈濠┅ㄤ彐躅泸遽翦铄鳝痨狴弪ㄡ泗矧徙泔躅舂⒚蝈狒弩铄痨狴弪骝镯翳玳鲥徙麸虍澡痨狴弪轶篝矧邃轭麸翳徙泔躅溽翎忉箦麒殪翳徙麸轶篝矧邃轭翳痱镳弪痨狴弪骈戾戾舄è铒铒鳗痨狴弪蝈泔蜾磲脲轭篝犷沐ю灬弪蝈泔蜾洪漕蹴ㄩ漕蹴镦徙麸颟横沣秕铘ㄩ漕蹴镦徙泔躅舂侯犴钺礤镦徙麸颟┅痫篝盹溴蝾哄邈豸ê轭箦螋轭麸ю灬弪后弭ч漕蹴ㄩ漕蹴镦徙麸颟п沣秕铘ㄩ漕蹴镦徙泔躅舂ь犴钺礤镦徙麸颟┅箦翩痨狴弪蟓镦徙泔躅舂钽镱痨狴弪蟓镦徙泔躅舂扉篝痨狴弪蝈泔蜾┅筢鲥徙泔躅徙泔躅舂箦翩糸綮瀛镦徙麸颟Ⅳ桢豸翦铄麾殄箦翩ㄢ轵翳糸礤镦徙麸颟铒鳗箦翩祜玳瞽糸礤镦徙麸颟铒鳗箦翩蝈铘泔溴镦徙麸颟с蝈狒轭绌筢鲥痨狴弪麸盱徙麸颟┅ㄤ彐躅溴戾翦痨狴弪ㄣ瑭换渺遽翳秣铄镦犷沆犷翳轶痨狴弪黹玷秣轭礤盹蝙ㄤ镬轶ㄣ灬瞽殇ㄨ狍璀脲沆犷螵┅戾è沆犷蝈犰沆犷沆犷殇┅麒孱ㄥ耢秣铄颦镦沆犷ㄩ漕蹴镦汨┅箦翩秣铄颦镦沆犷癌┅换渺遽翳秣铄镦犷沆犷翳轶痨狴弪黹玷秣镱翳溻痫篝盹溴蝾哄邈豸ê躔溽翦с灬铙后弭э黝弪侯蹯瑚桢蝈êэ黝弪ㄩ漕蹴镦汨┅┅换义盹鲥汨狎徙翦骝镯沆犷戾è沆犷蝈犰沆犷ㄣ灬瞽镦汨┅┅麒孱沆犷箦翩礤礅弪蟓镦沆犷ㄤ屐弭ㄩ漕蹴镦汨礤礅弪蟓镦沆犷┅┅痫篝盹溴蝾哄邈豸ê溴戾翦骝镯с灬钸礤礅弪瑚桢蝈êю灬弪ㄩ漕蹴镦汨┅┅换义盹鲥汨狎徙翦骝镯犷徙沐篌珧秕痼ㄤ镬轶ㄧ蝻躔ㄨ狍璀鲠祯弩徙沐篌珧秕痼殇铛愍┅箦翩礤礅弪蟓镦珧秕皓ㄤ屐弭ㄩ漕蹴镦汨礤礅弪蟓镦珧秕皓┅痫篝盹溴蝾哄邈豸ê溴戾翦骝镯箸蝻躔唔屙忮蝮瑚桢蝈êю灬弪ㄩ漕蹴镦汨┅┅换义盹鲥汨狎徙翦骝镯犷聃弩趔翳妁黹玷栳鲥觑轭邃躅戾篌弪镳聃弩舡殇镦汨┅戾è聃弩聃弩舡怡鲱蹴聃弩舡殇镦汨┅┅麒孱聃弩蝈盹鲥骝镯聃弩ㄩ漕蹴镦汨┅┅换义盹鲥汨狎徙翦骝镯趄躞翦扉篝麇栳鲥麸翎脲翳徙泔躅趔换轭礤盹蝙轭麸泔铙殇弪狒轱麒孱麇滹翳轶箫麇栳鲥麸顼换翳蝻蹒遽汨徙泔躅ㄤ镬轶ㄡ沣秕铘殇痫篝盹溴蝾厚蹂蝙ê箦戾泗п沣秕铘烘蝻趄躞翦瑚桢蝈êю灬弪ㄩ漕蹴镦汨┅红轶舂戾è徙泔躅祜徜徙泔躅徙泔躅舡殇┅箦翩趄躞舡镦徙泔躅舂ㄤ屐弭ㄩ漕蹴镦汨趄躞舡镦徙泔躅舂┅┅痫篝盹溴蝾哄邈豸ê溴戾翦骝镯趄躞翦瑚桢蝈êю灬弪ㄩ漕蹴镦汨┅┅换韵南义盹鲥骝镯翳怙躅豉扉篝换蝈盹鲥怙躅糸弩ㄩ漕蹴镦汨┅痫篝盹溴蝾哄邈豸ê溴戾翦骝镯р秕铘哞躅翦蝮瑚桢蝈ê矧êч漕蹴ㄩ漕蹴镦汨┅ê鲩泗轫ㄩ漕蹴镦汨┅┅换拈筢篌镢獒翦狨翳矧骝镯怙狎礤篌徵弩痫篝盹溴蝾哄邈豸ê躔溽翦р镝蜾唔弩筢珏后弭п豸栾侯蹯瑚桢蝈êп豸栾ㄩ漕蹴镦汨┅┅换义盹鲥汨狎徙翦骝镯徙泔躅箦翩痨狴弪蟓镦ㄡ沣秕铘镦汨┅ㄤ屐弭ㄩ漕蹴镦汨痨狴弪蟓镦ㄡ沣秕铘镦汨┅弘妁ч漕蹴镦┅痫篝盹溴蝾哄邈豸ê溴戾翦骝镯ю灬弪瑚桢蝈êч漕蹴ㄩ漕蹴镦汨┅┅换义盹鲥汨狎徙翦骝镯玑礤麒孱ㄩ瞽蝻镯镦汨箦钿麸汨狎汨⒘泔熹鏖钿忪秣翳蝻蹒秕箫蹯犷秕溟筢痧遽虍骘蝈鲥虍ア瘐蜱瀛泸遽趱蝈汨铋飑┅ㄤ彐躅溴痫箝舡骢趱蝈忉铍ㄡ沣秕铘犴秕铘⒛屦矬轸镣险卧轭麸翳骢趱蝈忉铍镦撩孟瘴援ㄣ桢汶豉疱徙泔躅徙泔躅舂ㄡ篌弪铒黹铛箴犴秕铘┅躅戾篌弪镳犴秕铘ㄩ钽ㄦ豸躜瀛忉铍镦徙泔躅舂犴秕铘筢鲥徙泔躅徙泔躅舂┅ㄤ彐躅鏖翳潋狩骢趱蝈忉铍ㄡ沣秕铘犴秕铘⒆轸桎蜥黧镣险卧骝镯翳骢趱蝈忉铍镦撩孟瘴援ㄣ桢汶豉疱徙泔躅徙泔躅舂ㄡ篌弪铒黹铛箴犴秕铘┅躅戾篌弪镳犴秕铘ㄤ邈ㄦ豸躜瀛忉铍镦徙泔躅舂犴秕铘筢鲥徙泔躅徙泔躅舂┅ㄤ彐躅溴痫箝舡疳篝忉铍ㄡ沣秕铘犴秕铘⒛屦矬轸镣险卧轭麸翳骢趱蝈忉铍镦撩孟瘴援ㄣ桢汶豉疱徙泔躅徙泔躅舂ㄡ篌弪铒黹铛箴犴秕铘┅躅戾篌弪镳犴秕铘ㄩ钽疳篝忉铍镦徙泔躅舂犴秕铘筢鲥徙泔躅徙泔躅舂┅ㄤ彐躅鏖翳潋狩疳篝忉铍ㄡ沣秕铘犴秕铘⒆轸桎蜥黧镣险卧骝镯翳疳篝忉铍镦撩孟瘴援ㄣ桢汶豉疱徙泔躅徙泔躅舂ㄡ篌弪铒黹铛箴犴秕铘┅躅戾篌弪镳犴秕铘ㄤ邈疳篝忉铍镦徙泔躅舂犴秕铘筢鲥徙泔躅徙泔躅舂┅