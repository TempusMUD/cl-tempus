(in-package :tempus)

(defclass player-record ()
  ((idnum :accessor idnum-of :initarg :idnum)
   (account :accessor account-of :initarg :account)
   (name :accessor name-of :initarg :name)
   (birth-time :accessor birth-time-of :initarg :birthtime)
   (login-time :accessor login-time-of :initarg :logintime)))

(defclass account ()
  ((idnum :accessor idnum-of :initarg :idnum)
   (name :accessor name-of :initarg :name)
   (password :accessor password-of :initarg :password)
   (email :accessor email-of :initarg :email)
   (creation-time :accessor creation-time-of :initarg :creation-time)
   (creation-addr :accessor creation-addr-of :initarg :creation-addr)
   (login-time :accessor login-time-of :initarg :login-time)
   (login-addr :accessor login-addr-of :initarg :login-addr)
   (entry-time :accessor entry-time-of :initarg :entry-time)
   (ansi-level :accessor ansi-level-of :initarg :ansi-level :initform 0)
   (compact-level :accessor compact-level-of :initform 0)
   (term-height :accessor term-height-of :initarg :term-height :initform 22)
   (term-width :accessor term-width-of :initarg :term-width :initform 80)
   (players :accessor players-of)
   (bank-past :accessor past-bank-of :initform 0)
   (bank-future :accessor future-bank-of :initform 0)))

(defvar *account-max-idnum* 0)
(defvar *account-idnum-cache* (make-hash-table))
(defvar *account-name-cache* (make-hash-table :test 'equal))

(defun random-salt ()
  "Returns a string of the format $1$xxxxxxxx$ where x is a random
alphanumeric character.  This is for use in making crypt() return an
md5 hash."
  (let ((salt-table
		 "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz./"))
	(format nil "$1$狺あ祜镳蝈疱狒泔祆邈ㄣ栳筢祠翎忪蜥钿镯洞┅┅┅ㄤ彐躅箦翩疳篌黠蜾镦疳篌黠蜾徙泔躅舂⒃栝轶箪雉黩轸弪骘徙泔躅疳篌黠蜾麒殂狨麸磲糸汜祆栳箬弩翳疳篌黠蜾箦翩箪雉鲠祯徙泔躅ю狍篦矧洎ㄣ蝙痿疳篌黠蜾疳篌黠蜾蜥钿镯筢祠┅┅ㄤ彐躅徙泔躅舡怙雉ī箪镧⑶弭糸铉磲徙泔躅殇铛恝箦翩徙泔躅舡磲殇铛愍磲徙泔躅舡殇┅箪镧⑶弭糸铉汨狎徙翦泔躅簪戾è痨狴弪泔躅聃弪ê箦戾泗ê泔躅И烘蝻ю灬弪螬后轭珈濠┅ㄩ弪镳痨狴弪泔躅舂箪镧⒆烈紊吻物汨狎徙翦蝮祜徜邃箪镧汨狎徙翦蟒轭溻痨狴弪泔躅痨狴弪泔躅舂┅ㄤ彐躅磲徙泔躅舡殇ī⒁弭躜铙翳磲轫蹴徙泔躅殇轭翳溽翎忉箦矧聃弪ê箦戾泗ê磲ч漕蹴烘蝻п沣秕铘螬后轭珈濠癌ㄤ彐躅磲痨狴弪殇ī⒁弭躜铙翳磲轫蹴痨狴弪殇轭翳溽翎忉箦矧聃弪ê箦戾泗ê磲ч漕蹴烘蝻ю灬弪螬后轭珈濠癌ㄤ彐躅徙泔躅舡屮轶趔钺礤⒁弭躜铙趄蹂殒翳徙泔躅鏖翳翳玳鲥钺礤屮轶趔澡泔眇狎轶镱轶汜箦轭箦铙轸轹瀹聃弪ê箦戾泗ê泔躅И烘蝻п沣秕铘瑚桢蝈êê祜麇ь犴濠篝蜷铉滹黝汜箦钺礤┅后轭珈濠暴ㄤ彐躅祜徜徙泔躅钺礤⒁弭躜铙翳徙泔躅狍箫汩狒邃鏖翳翳玳鲥钺礤澡徙泔躅磲忮祜徜邃骝镯翳溽翎忉箦矧轸磲忮蝈趄殄鲥骝镯汜汨瀹戾舄è汜铒铋汜飙钺礤篝蜷铉滹黝汜箦钺礤┅ㄣ徙桢ㄧ弭栳箬汜铒铋汜飙钺礤徙泔躅舡钺礤汜汨濯铋飑┅ㄩ汜汨邃汜汨邃戾è蝈篚祠聃弪ê箦戾泗И烘蝻п沣秕铘瑚桢蝈êê祜麇ь犴濠汜铒铋汜飙钺礤┅横扉篝┅蝈趄殄鲥磲脲轭篝犷沐п沣秕铘┅祜镳骘ㄦ殄熹鲠祯濠轭蝈趄殄鲥滹箦翩箪雉鲠祯徙泔躅骈屐洎鲠祯濠ㄣ镱蝈趄殄鲥箦翩ㄧ弭栳箬钺礤镦蝈趄殄鲥洎徙泔躅舡钺礤汜汨濯蝈趄殄鲥洎箦翩ㄧ弭栳箬ㄩ漕蹴镦蝈趄殄鲥洎徙泔躅舡殇铛憝汜汨濯蝈趄殄鲥洎箦翩痨狴弪蟓镦蝈趄殄鲥洎箫螋痨狴弪蟓镦蝈趄殄鲥洎＇弘妁＇殇铛憝镦┅蝈趄殄鲥洎铋飑┅┅ㄤ彐躅筢鲥徙泔躅ㄡ沣秕铘⒂狯弩翳徙泔躅轭骘蝽狒轱轭麸翳溽翎忉箦ㄥ邈豸ê躔溽翦п沣秕铘后弭ь犴钺礤镦徙泔躅舂ю狍篦矧疳篌黠蜾镦徙泔躅舂у磲殪ㄥ磲殪镦徙泔躅舂ъ镧轭糸礤祜玳瞽糸礤镦徙泔躅舂ъ镧轭徜潋祜玳瞽徜潋镦徙泔躅舂у铘蝙糸礤ㄥ铘蝙糸礤镦徙泔躅舂п铙榄戾鲥ㄡ铙榄戾鲥飙镦徙泔躅舂с镯疳泗戾鲥ㄣ镯疳泗戾鲥飙镦徙泔躅舂翦蝽桢殓梏翦蝽桢殓梏镦徙泔躅舂翦蝽鏖漪翦蝽鏖漪璀镦徙泔躅舂р犷氕疳篝疳篝忉铍镦徙泔躅舂р犷氕骢趱蝈ㄦ豸躜瀛忉铍镦徙泔躅舂瑚桢蝈êч漕蹴ㄩ漕蹴镦徙泔躅舂┅┅ㄤ彐躅徙泔躅舡祜玳ㄡ沣秕铘⑿弪骘蝽铄沐篌狎翎箅骘犷徙泔躅躔镱篚沣弩箧蹯祜玳町簌箪镧祜珑邃轭钺礤镦徙泔躅舂┅换吁痧矧骘孱泸痿邃疳篌黠蜾趄犷箜轶箝镱－筲沆ㄥ鲠飙麒孱ê泔眇殪瀛麸痨弼屐红镝洵麸痨弼屐哄邈豸濠ㄤ彐鲠泸痿扉怛狎祜徜邃铋飑躅戾篌泸痿扉怛狎祜徜邃蹑骈红镝洵骘蝈殓瞽扉怛狎蹑骈烘轭洵骘蝈殓瞽扉怛狎㈧殁泸痿Ж＋洞忾躞虔扉舛疮躞虔扉獐躞虔祜汜殳扉獐扉獐┅后躔痫螋轭绛扉怛狎殄Ж恽┅箦赳泸痿扉怛狎祜徜邃舂┅蹑骈轰彐骢钽糸镱á泸痿泸痿è脲恒篝蜷铉筢祠恒篝蜷铉┅候弭躜铋铉恒篝蜷铉ㄤ彐躅泸痿疳篌黠蜾疳篌黠蜾筢祠⑴钽蝙痿疳篌黠蜾鏖翳栳箬蹑骈瑚轸璀泱趄轭疳篌黠蜾泱趄轭疳篌黠蜾蹑骈瑚轸璀泱趄轭筢祠泱趄轭筢祠蹑骈恒镱鲥螋骝镯泱趄轭ㄣ蝙痿疳篌黠蜾泱趄轭筢祠泱趄轭绌┅┅ㄤ彐躅汨邈氕疳篌黠蜾ㄡ沣秕铘疳篌黠蜾⒛弭弪黹铄殒翳栳箬镦翳玳鲥疳篌黠蜾磲翥桢翳篝矧邃栳箬篝蜷铉疳篌黠蜾镦徙泔躅舂ㄣ蝙痿疳篌黠蜾疳篌黠蜾疳篌黠蜾镦徙泔躅舂┅ㄤ彐躅鲠扉溽翦钺礤钺礤⒁弭躜铙殒翳玳鲥篝蜷铉轶镫麸躞狍痨狴弪钺礤义趱蝾紊殒轸轶轭鲠扉轭箫礤麽ㄡ钿铒篝蜷铉钺礤┅ㄥ鲥蝙灬礅溽ㄣ矧ㄥ耢＼Зㄡ祓栳汨狎悌┅钺礤┅ㄤ彐躅痨狴弪钺礤屮轶趔钺礤⒁弭躜铙殒痨狴弪屮轶趔鏖翳翳玳鲥钺礤痨躞聃弪ê箦戾泗ê泔躅И烘蝻ю灬弪瑚桢蝈êê祜麇ь犴濠篝蜷铉滹黝汜箦钺礤┅后轭珈濠┅ㄤ彐躅蝈趄殄鲥痨狴弪殇铛钺礤⒁弭蜷弼弩翳殇铛镦翳痨狴弪鏖翳翳玳鲥钺礤骝镯翳溽翎忉箦义趱蝾紊殒翳痨狴弪溟铒屮轶舢聃弪ê箦戾泗ч漕蹴烘蝻ю灬弪瑚桢蝈êê祜麇ь犴濠篝蜷铉滹黝汜箦钺礤┅后轭珈濠ㄤ彐躅蝈趄殄鲥痨狴弪钺礤ㄩ漕蹴⒁弭蜷弼弩翳钺礤镦翳痨狴弪鏖翳翳玳鲥殇铛骝镯翳溽翎忉箦义趱蝾紊殒翳痨狴弪溟铒屮轶舢聃弪ê箦戾泗ь犴烘蝻ю灬弪瑚桢蝈êч漕蹴殇铛愆后轭珈濠ㄤ彐躅泸遽翦铄鳝痨狴弪ㄡ泗矧徙泔躅舂⒚蝈狒弩铄痨狴弪骝镯翳玳鲥徙麸虍澡痨狴弪轶篝矧邃轭麸翳徙泔躅溽翎忉箦麒殪翳徙麸轶篝矧邃轭翳痱镳弪痨狴弪骈戾戾舄è铒铒鳗痨狴弪蝈泔蜾磲脲轭篝犷沐ю灬弪蝈泔蜾洪漕蹴ㄩ漕蹴镦徙麸颟横沣秕铘ㄩ漕蹴镦徙泔躅舂侯犴钺礤镦徙麸颟衡轵翳糸礤铒红镧轭糸礤铒鳗┅ㄥ邈豸ê轭箦螋轭麸ю灬弪后弭ч漕蹴ㄩ漕蹴镦徙麸颟п沣秕铘ㄡ沣秕铘镦徙麸颟ь犴钺礤镦徙麸颟р轵翳糸礤铒ъ镧轭糸礤铒鳗箦翩痨狴弪蟓镦徙泔躅舂钽镱痨狴弪蟓镦徙泔躅舂扉篝痨狴弪蝈泔蜾┅筢鲥徙泔躅徙泔躅舂箦翩糸綮瀛镦徙麸颟Ⅳ桢豸翦铄麾殄筢鲥痨狴弪徙麸颟┅ㄤ彐躅筢鲥痨狴弪痨狴弪⒂狯弩翳痨狴弪轭麸翳痨狴弪骈戾犷轸羼蹰痦孱轭麸轸羼蹰痦孱骈戾鏖翳镳孱骈戾秕痨狴弪疳翳钺礤ㄩ漕蹴镦痨狴弪┅轰轵邈糸镱猴豸瘐洪姝屮轶趔后躔弪箦溴洪姝滹弩铒舡屮轶恒蝈狒濠ㄦ矧磲秕痨狴弪洪漕蹴侯犴烘蹯飙溴筱后屮后疱汩弩哄瀛溴筱鸿衢颦溴筱猴鲥蜥祆溴筱横扉珙鸿彘玷瑚彘玷后趄孱玺横玳扉豉呼轸戾吼蝈骟吼灬弪犰獒箦鸿镯红镝漯灬沐吼镲骈吼镲骘豸恒蝈狒邃糸礤轰遽翳喉腴祆吼腴祆吼蜷鲠翦钺礤螬アㄩ漕蹴镦痨狴弪钺礤镦痨狴弪ㄦ蹯飙溴筱镦痨狴弪箦痨狴弪箴邈殄痨狴弪ㄥ瀛溴筱镦痨狴弪ㄨ衢颦溴筱镦痨狴弪秭弪犰飙溴筱镦痨狴弪ㄡ扉珙痨狴弪ㄨ彘玷痨狴弪麇殓梏镦痨狴弪篝蝈铉翳痨狴弪ㄡ玳扉豉痨狴弪糸綮痨狴弪痨狴弪痱彐蟓扉篝痱彐痨狴弪┅痨狴弪犰獒箦痨狴弪ㄨ镯痨狴弪祜徜痨徙痨狴弪痫镦轭痨狴弪痫镦秕痨狴弪ㄣ蝈狒邃糸礤镦痨狴弪ㄤ遽翳蟓镦痨狴弪黼殪祗镦痨狴弪痣殪祗镦痨狴弪ㄨ狍璀麸狍箫痱轹狒瀛钺礤蟓镦痨狴弪┅┅换俞鲥翳羼蹰痦孱铒鳜矧溴戾翦殒翳痨狴弪栳铒铄戾è疳翳ㄥ聃轲礤铘疳翳钺礤ㄩ漕蹴镦痨狴弪┅┅ㄩㄣ狎蝙轭痨狴弪鏖翳镳孱骈戾秕疳翳轰轵邈糸镱猴豸瘐洪姝屮轶趔后躔弪箦溴洪姝滹弩铒舡屮轶恒蝈狒濠ㄤ镬轶ㄩ翦ㄣ狎蝙轭痨狴弪┅黩轸瀛轸屙轸屙秕姗┅麒孱痱镡瀛骈戾疳翳ㄤ屐弭瀛骈戾疳翳┅┅ㄤ彐躅祜徜羼蹰痦孱ㄩ漕蹴⒁弭躜铙扉篝镦犰翳羼蹰痦孱轭翳羼蹰痦孱骈戾麒孱痱镡瀛骈戾ㄥ聃轲礤铘疳翳钺礤殇铛愆鏖翳镳孱骈戾ㄩ铈ㄥ聃轲礤铘疳翳钺礤殇铛愆轰轵邈糸镱洪铕豸祜镳骘溴筱蝈徜轭铋铋飑麒殪溴筱泔祆邈祜徜轸屙溴筱轭麸蝈篚祠骈钺祆蝈趱蝾铗弼弪箦蝈篚祠┅┅┅